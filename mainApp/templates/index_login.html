<!DOCTYPE html>
<html dir="rtl">

    <head>
        <meta charset="utf-8">      
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
        <meta name="viewport" content="width=device-width">
        <meta name="google-signin-scope" content="profile email">
        
        <meta name="google-signin-client_id" content="204450024885-4s8o46icvli7m58qfm2jbfs6ksf8b75q.apps.googleusercontent.com">
        

      {%load static%}
        {% load i18n %}
        {% get_current_language as LANGUAGE_CODE %}

      
      <link rel="icon" type="image/png" sizes="32x32" href="/static/images/Logo 2.png">
      <!--Start of the imports css-->
     
         

        <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/all.min.css' %}"> -->
        <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrapLogin.min.css' %}">
        <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/owl.carousel.min.css' %}"> -->
        <link rel="stylesheet" type="text/css" href="{% static 'css/index_style.css' %}">
       
     

        <title>{% trans "Login" %}</title>
        <style>
            body {
                 background: #4f4d4d;
                font-family: 'Poppins', sans-serif;
                background-size: cover!important; 
                
    background-image: url(/static/images/back1.jpg);
    background-size: auto;
    background-blend-mode: overlay;

            }
        </style>
      <!--End of the imports css-->
      </head>



        <body >
            {% csrf_token %}
            <div id="loading">
                <div id="loadingImg"></div>
              </div>
    

                        <div class="container">
                            <div class="row mt-5">
                                <div class="col-md-4 col-4"></div>
                                <div class="col-md-4 col-4"><img src="/static/images/Logo 2.png" alt="logo" style="width: 100%;"/></div>
                                <div class="col-md-4 col-4"></div>
                                
                               
                            </div>


                            <div class="row mt-5">
                                <div class="col-md-3 col-1"></div>
                                <div class="col-md-6 col-10" style=" background: #ffffffd6;padding: 18px;border-radius: 35px;box-shadow: 0px 1px 5px 5px #c0bcbc;">
                                    <div class="login-block col-sm-12">
                                        <h1 style=" text-align: center; ">{% trans "Login" %}</h1>
                                        <p style=" text-align: center; ">{% trans "Please Enter your Credentials" %}</p>
                                        <form id="formLogin" class="ng-untouched ng-pristine ng-valid container">
                                            {% csrf_token %}
                                            <hr class="hr-xs">
                                            <div class="form-group row">
                                                <div class="input-group">
                                                    <span class="input-group-addon mt-1 ml-2">
                                                        <i class="fa fa-user ti-email"></i>
                                                    </span>
                                                    <input type="text" value="" placeholder='{% trans "Please Enter the user name" %}' name="username" class="form-control" id="Username" placeholder="Username" style="padding-right: 10px;">
                                                </div>
                                            </div>
                                            <hr class="hr-xs">
                                            <div class="form-group row">
                                                <div class="input-group">
                                                    <span class="input-group-addon mt-1 ml-2">
                                                        <i class="fa fa-lock ti-unlock"></i>
                                                    </span>
                                                    <input type="password" value="" placeholder='{% trans "Secret Number " %}' name="password" id="password" class="form-control" style="padding-right: 10px;">
                                                </div>
                                            </div>
                                            <div class=" row mt-3">
                                                <a  id="loginButton" href="javascript:void(0)" class="btn btn-block" style="background-color: #e6aa32d9;font-family: system-ui;font-size: 17px;font-weight: 500;">{% trans "Login" %}  </a>
                                            </div>
                                            <hr class="hr-xs mt-4 mb-0">
                                            <div class="row">
                                                       
                                                        <p id="text2">{% trans "OR Login with" %}</p>
                                                       
                                                        
                                                        
                                             </div>
                                             
                                            <div class=" row ">
                                                <div class="col-6">

                                                    
                                                <!-- <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
                                                </fb:login-button>

                                                <div id="status">
                                                </div> -->

                                                    <button id="facebook" type="button" onclick="fb_login();"><span>Facebook</span><img id="facebook1" src="https://image.flaticon.com/icons/svg/174/174848.svg"></button>
                                                </div>

                                                <div class="col-6">
                                                    <button id="google" type="button" for="g-signin2"><span>Google</span><img id="google1" src="/static/images/google.png"></button>
                                                </div>
                                            </div>

                                            <div class=" row">
                                                <div class="col-6 p-0">
                                                <p id="text3">{% trans "Not a Memeber?" %} </p> 
                                                </div>
                                                <div class="col-6 p-0 pr-2">
                                                    <p style="text-align: right;">
                                                        <a id="signup" href="/loadRegPage/">{% trans "Join Us" %}</a>
                                                    </p>
                                                </div>
                                            </div>
                                        </form>
                                        
                                        
                                    </div>
                                </div>
                                <div class="col-md-4"></div>
                            </div>
                        </div>

                       
                  
                        <script src="{% static 'js/jquery-3.5.1.js' %}"></script> 
                        <!-- <script src="{% static 'js/popper.min.js' %}"></script>  -->
                        <script src="{% static 'js/bootstrap.min.js' %}"></script> 
                        <script src="{% static 'js/sweetalert.min.js' %}"></script>
                        
                        <!-- <script src="{% static 'js/jquery.easing.1.3.js' %}"></script>  -->
                        <!-- <script src="{% static 'js/owl.carousel.min.js' %}"></script> -->
                        <!-- <script src="{% static 'js/mainFunctions.js' %}"></script> -->
            
                 
<script src="https://apis.google.com/js/api:client.js?onload=onLoadCallback" async defer></script>          
<script>
    var csrftoken = $("input[name='csrfmiddlewaretoken']").val();

    

function showLoader(){
    // $('#loading').fadeIn('fast');
    $('#loading').css({display:'block'});
    // console.log('Showennn');
}

function hideLoader(){
    $('#loading').css({display:'none'});
    // console.log('hide');
}


var auth2;
var googleUser = {};
var auth3;


element = document.getElementById('google');

function fb_login(){
    FB.login(function(response) {

        if (response.authResponse) {
            console.log('Welcome!  Fetching your information.... ');
            //console.log(response); // dump complete info
            access_token = response.authResponse.accessToken; //get access token
            user_id = response.authResponse.userID; //get FB UID

            FB.api('/me?fields=id,name,email,first_name,last_name,picture.type(large)', function(response) {
                    // console.log("ahhhhhhhhhh: "+response.name);
                    SignInNowSocial(response.name.replace(/\s/g, ''),response.email,
                    response.first_name,
                    response.last_name,
                response.picture.data.url,2,"Facebook");

                    console.log(response.picture.data.url);
                    console.log(response.first_name);
                    console.log(response.last_name);
                    console.log(response.email);
                
                    }); 

        } else {
            //user hit cancel button
            console.log('User cancelled login or did not fully authorize.');

        }
    }, {
        scope: 'public_profile,email,user_photos'
    });
}



    window.fbAsyncInit = function() {
      FB.init({
        appId      : '363144762180447',
        cookie     : true,
        xfbml      : true,
        version    : 'v11.0'
      });
        console.log("FbLoaded");
        
    };
  
    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>
                        
            <script>
 
    


    function SignInNowSocial(username,mail,firstname,lastname,imgUrl,role,typeOfRegisteration){
        showLoader();
                
        $.ajax({
                  type: 'POST',
                  url: '/{{LANGUAGE_CODE}}/AuthOutSide',
                  dataType: 'json',
                  data: { 
                      'username':username,
                      'email':mail,
                      'lastName':lastname,
                      'firstName':firstname,
                      'role':role,
                      'img':imgUrl,
                      'typeOfRegisteration':typeOfRegisteration
                  },
                  headers:{
                      "X-CSRFToken": csrftoken
                          },
                  cache: false,
                  success: function(result) {
                      
                      hideLoader();
                      console.log(result)
                      if(result.State=="Ok"){
                        var urlNew = result['RedirectUrl'];
       
                        // console.log(urlNew.includes("/accounts/login/"))
                        if(urlNew.includes("/accounts/login/")){
        
                            var urlNew = result['RedirectUrl'].substr(result['RedirectUrl'].indexOf("next=/")+"next=/".length, result['RedirectUrl'].length);
                            window.location.href = decodeURIComponent("/"+urlNew);
                        }else if(result.ableToLogin=='Yes'){
                                window.location.href = result.RedirectUrl;
                            }else{
                                
                                // swal("مشكلة",result.Error, "error");
                        swal('{% trans "Error" %}', result.Error, "error");
                            }

                      }else{
                        swal('{% trans "Error" %}', '{% trans "Error while Login" %}', "error");
                      }
                    
                  },
                  error: function (xhr, ajaxOptions, thrownError) {
                    hideLoader();
                        swal('{% trans "Error" %}', '{% trans "Error while Login" %}', "error");
                  }
              });

              
    }

         

window.onLoadCallback = function(){
            gapi.load('auth2', function() {
                auth2 = gapi.auth2.init({
                client_id: '204450024885-4s8o46icvli7m58qfm2jbfs6ksf8b75q.apps.googleusercontent.com',
                cookiepolicy: 'single_host_origin',
                scope: 'profile'
                });
    

                auth3 = true;
                startApp();

           
            });
    
    };

    function startApp(){
      auth2.attachClickHandler(element, {},
                function(googleUser) {
                    var profile = googleUser.getBasicProfile();
                   
                    //console.log(profile.getName().replace(/\s/g, ''));
                    SignInNowSocial(profile.getName().replace(/\s/g, ''),profile.getEmail(),
                    profile.getGivenName(),
                    profile.getFamilyName(),
                    profile.getImageUrl(),2,'Gmail');
    
                }, function(error) {
                    
                    swal('{% trans "Error While Login" %}', '{% trans "Problem" %}', "error");
                    
                }
                );
    }
    
    
    if (auth3){
        startApp();
    }


                $('#loginButton').on('click', function() {
                    login();
 });

 $("#formLogin").keyup(function(event) {
    if (event.keyCode === 13) {
       // Add your logic to submit to your backend server here.
                login();
           
    }
});


function login(){

var username = $('#Username').val();
var password = $('#password').val();

if (username==""||password==""){
    // swal("مشكلة", " برجاء مراجعة الأسم والرقم السرى !", "error");
       
    swal('{% trans "Please Revies Username or Password" %}', '{% trans "Problem" %}', "error");
    
}else{

//Auth
$('#loginButton').html('Loging ... ');

$.ajax({
    type: 'POST',
    url: '/{{LANGUAGE_CODE}}/authUser',
    data: { 
        'username': username,
        'password': password
    },
    headers:{
        "X-CSRFToken": csrftoken
         },
    dataType: 'json',
    cache: false,
    success: function(result) {
        console.log(result);
       if(result['Result']=='Success'){
        var urlNew = result['url'];
       
         console.log(urlNew);
        if(urlNew.includes("/accounts/login/")){
        //     window.location.href = "/";
        // }else{
            var urlNew = result['url'].substr(result['url'].indexOf("next=/")+"next=/".length, result['url'].length);
            window.location.href = decodeURIComponent("/"+urlNew);
        }
       }else{

        $('#loginButton').html('SIGN IN');
        
        swal('{% trans "No one registered with this username or password" %}', '{% trans "Problem" %}', "error");
        // swal("مشكلة", "لايوجد شخص مسجل بهذه البيانات برجاء مراجعة الأسم والرقم السرى !", "error");
       
       }
    },error: function (xhr, ajaxOptions, thrownError) {
        console.log(thrownError)
           }
});
}


}
            </script>
        </body>
   
</html>